<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="LeakCanary,内存泄露," />





  <link rel="alternate" href="/atom.xml" title="Lieeber's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="¶使用 LeakCanary是Square为Android应用提供的一个监测内存泄露的工具，源码地址：https://github.com/square/leakcanary。 在gradle文件中引入依赖： 123456dependencies &amp;#123;  debugImplementation &apos;com.squareup.leakcanary:leakcanary-android:1.6.">
<meta name="keywords" content="LeakCanary,内存泄露">
<meta property="og:type" content="article">
<meta property="og:title" content="LeakCanary的使用及原理">
<meta property="og:url" content="http://yoursite.com/2018/07/10/第三方框架/LeakCanary的使用及原理/index.html">
<meta property="og:site_name" content="Lieeber&#39;s Blog">
<meta property="og:description" content="¶使用 LeakCanary是Square为Android应用提供的一个监测内存泄露的工具，源码地址：https://github.com/square/leakcanary。 在gradle文件中引入依赖： 123456dependencies &amp;#123;  debugImplementation &apos;com.squareup.leakcanary:leakcanary-android:1.6.">
<meta property="og:image" content="http://osphuquui.bkt.clouddn.com/18-8-15/87322123.jpg">
<meta property="og:updated_time" content="2018-08-15T03:01:23.646Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LeakCanary的使用及原理">
<meta name="twitter:description" content="¶使用 LeakCanary是Square为Android应用提供的一个监测内存泄露的工具，源码地址：https://github.com/square/leakcanary。 在gradle文件中引入依赖： 123456dependencies &amp;#123;  debugImplementation &apos;com.squareup.leakcanary:leakcanary-android:1.6.">
<meta name="twitter:image" content="http://osphuquui.bkt.clouddn.com/18-8-15/87322123.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/07/10/第三方框架/LeakCanary的使用及原理/"/>





  <title>LeakCanary的使用及原理 | Lieeber's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8189d5a89151e08eb9a35a3be96dfd2e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lieeber's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">欢迎光临我的技术博客。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/10/第三方框架/LeakCanary的使用及原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lieeber">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://image-1252244366.costj.myqcloud.com/lieeber.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lieeber's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LeakCanary的使用及原理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-10T12:18:15+08:00">
                2018-07-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/第三方框架/" itemprop="url" rel="index">
                    <span itemprop="name">第三方框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2018/07/10/第三方框架/LeakCanary的使用及原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="使用"><a class="header-anchor" href="#使用">¶</a>使用</h3>
<p>LeakCanary是Square为Android应用提供的一个监测内存泄露的工具，源码地址：<a href="https://github.com/square/leakcanary%E3%80%82" target="_blank" rel="external">https://github.com/square/leakcanary。</a>
在gradle文件中引入依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">  debugImplementation <span class="string">'com.squareup.leakcanary:leakcanary-android:1.6.1'</span></div><div class="line">  releaseImplementation <span class="string">'com.squareup.leakcanary:leakcanary-android-no-op:1.6.1'</span></div><div class="line">  <span class="comment">// Optional, if you use support library fragments:</span></div><div class="line">  debugImplementation <span class="string">'com.squareup.leakcanary:leakcanary-support-fragment:1.6.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>在项目的Application中添加检测：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    <span class="keyword">if</span> (LeakCanary.isInAnalyzerProcess(<span class="keyword">this</span>)) &#123;</div><div class="line">      <span class="comment">// This process is dedicated to LeakCanary for heap analysis.</span></div><div class="line">      <span class="comment">// You should not init your app in this process.</span></div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    LeakCanary.install(<span class="keyword">this</span>);</div><div class="line">    <span class="comment">// Normal app init code...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果检测到有内存泄漏，手机桌面会多出一个图标，点进去查看可以看见泄漏信息。
<img src="http://osphuquui.bkt.clouddn.com/18-8-15/87322123.jpg" alt=""></p>
<h3 id="原理"><a class="header-anchor" href="#原理">¶</a>原理</h3>
<h4 id="监听"><a class="header-anchor" href="#监听">¶</a>监听</h4>
<p>在Android中，当一个Activity走完onDestroy生命周期后，说明该页面已经被销毁了，应该被系统GC回收。通过Application.registerActivityLifecycleCallbacks()方法注册Activity生命周期的监听，每当一个Activity页面销毁时候，获取到这个Activity去检测这个Activity是否真的被系统GC。</p>
<h4 id="检测"><a class="header-anchor" href="#检测">¶</a>检测</h4>
<p>当获取了待分析的对象后，需要确定这个对象是否产生了内存泄漏。
通过WeakReference + ReferenceQueue来判断对象是否被系统GC回收，WeakReference 创建时，可以传入一个 ReferenceQueue 对象。当被 WeakReference 引用的对象的生命周期结束，一旦被 GC 检查到，GC 将会把该对象添加到 ReferenceQueue 中，待ReferenceQueue处理。当 GC 过后对象一直不被加入 ReferenceQueue，它可能存在内存泄漏。
当我们初步确定待分析对象未被GC回收时候，手动触发GC，二次确认。</p>
<h4 id="分析"><a class="header-anchor" href="#分析">¶</a>分析</h4>
<p>分析这块使用了Square的另一个开源库haha，<a href="https://github.com/square/haha%EF%BC%8C%E5%88%A9%E7%94%A8%E5%AE%83%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84heap%E5%A0%86%E4%BF%A1%E6%81%AF%E7%9A%84%E5%BF%AB%E7%85%A7snapshot%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87%E5%BE%85%E5%88%86%E6%9E%90%E5%AF%B9%E8%B1%A1%E5%8E%BBsnapshot%E9%87%8C%E9%9D%A2%E5%8E%BB%E6%9F%A5%E6%89%BE%E5%BC%BA%E5%BC%95%E7%94%A8%E5%85%B3%E7%B3%BB%E3%80%82" target="_blank" rel="external">https://github.com/square/haha，利用它获取当前内存中的heap堆信息的快照snapshot，然后通过待分析对象去snapshot里面去查找强引用关系。</a></p>
<h3 id="源码分析"><a class="header-anchor" href="#源码分析">¶</a>源码分析</h3>
<p>检测过程主要分为两个部分
监听Activity销毁，并判断是否存在内存泄漏
找到内存泄漏的对象的引用路径</p>
<h4 id="监听-v2"><a class="header-anchor" href="#监听-v2">¶</a>监听</h4>
<p>直接从LeakCanary.install()方法开始看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates a &#123;<span class="doctag">@link</span> RefWatcher&#125; that works out of the box, and starts watching activity</div><div class="line"> * references (on ICS+).</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RefWatcher <span class="title">install</span><span class="params">(Application application)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> refWatcher(application).listenerServiceClass(DisplayLeakService.class)</div><div class="line">      .excludedRefs(AndroidExcludedRefs.createAppDefaults().build())</div><div class="line">      .buildAndInstall();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Builder to create a customized &#123;<span class="doctag">@link</span> RefWatcher&#125; with appropriate Android defaults.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AndroidRefWatcherBuilder <span class="title">refWatcher</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AndroidRefWatcherBuilder(context);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>install()方法中首先实例化了一个AndroidRefWatcherBuilder类。
然后使用listenerServiceClass()方法设置了DisplayLeakService类，这个类用于分析内存泄漏结果信息，然后发送通知给用户。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidRefWatcherBuilder</span> <span class="keyword">extends</span> <span class="title">RefWatcherBuilder</span>&lt;<span class="title">AndroidRefWatcherBuilder</span>&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">/**</span></div><div class="line">    * Sets a custom &#123;<span class="doctag">@link</span> AbstractAnalysisResultService&#125; to listen to analysis results. This</div><div class="line">    * overrides any call to &#123;<span class="doctag">@link</span> #heapDumpListener(HeapDump.Listener)&#125;.</div><div class="line">    */</div><div class="line">    <span class="function"><span class="keyword">public</span> AndroidRefWatcherBuilder <span class="title">listenerServiceClass</span><span class="params">(</span></span></div><div class="line">      Class&lt;? extends AbstractAnalysisResultService&gt; listenerServiceClass) &#123;</div><div class="line">        <span class="keyword">return</span> heapDumpListener(<span class="keyword">new</span> ServiceHeapDumpListener(context, listenerServiceClass));</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefWatcherBuilder</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">RefWatcherBuilder</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">heapDumpListener</span><span class="params">(HeapDump.Listener heapDumpListener)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.heapDumpListener = heapDumpListener;</div><div class="line">        <span class="keyword">return</span> self();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后调用excludedRefs()方法设置添加一些白名单。在AndroidExcludedRefs类中以枚举的形式定义了忽略列表信息，如果这些列表中的类发生了内存泄漏，并不会显示出来，同时HeapAnalyzer在计算到GC roots的强引用路径，也会忽略这些类。如果你想自己的某个类泄漏了，LeakCanary不提示，就加到这个类中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> AndroidExcludedRefs &#123;</div><div class="line">    ACTIVITY_CLIENT_RECORD__NEXT_IDLE(VERSION.SDK_INT &gt;= <span class="number">19</span> &amp;&amp; VERSION.SDK_INT &lt;= <span class="number">21</span>) &#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Builder excluded)</span> </span>&#123;</div><div class="line">            excluded.instanceField(<span class="string">"android.app.ActivityThread$ActivityClientRecord"</span>, <span class="string">"nextIdle"</span>).reason(<span class="string">"Android AOSP sometimes keeps a reference to a destroyed activity as a nextIdle client record in the android.app.ActivityThread.mActivities map. Not sure what\'s going on there, input welcome."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    SPAN_CONTROLLER(VERSION.SDK_INT &lt;= <span class="number">19</span>) &#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(Builder excluded)</span> </span>&#123;</div><div class="line">            String reason = <span class="string">"Editor inserts a special span, which has a reference to the EditText. That span is a NoCopySpan, which makes sure it gets dropped when creating a new SpannableStringBuilder from a given CharSequence. TextView.onSaveInstanceState() does a copy of its mText before saving it in the bundle. Prior to KitKat, that copy was done using the SpannableString constructor, instead of SpannableStringBuilder. The SpannableString constructor does not drop NoCopySpan spans. So we end up with a saved state that holds a reference to the textview and therefore the entire view hierarchy &amp; activity context. Fix: https://github.com/android/platform_frameworks_base/commit/af7dcdf35a37d7a7dbaad7d9869c1c91bce2272b . To fix this, you could override TextView.onSaveInstanceState(), and then use reflection to access TextView.SavedState.mText and clear the NoCopySpan spans."</span>;</div><div class="line">            excluded.instanceField(<span class="string">"android.widget.Editor$EasyEditSpanController"</span>, <span class="string">"this$0"</span>).reason(reason);</div><div class="line">            excluded.instanceField(<span class="string">"android.widget.Editor$SpanController"</span>, <span class="string">"this$0"</span>).reason(reason);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后调用了buildAndInstall()方法，创建了一个RefWatcher对象并返回了，这个对象用于检测是否有对象未被回收导致内存泄漏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Creates a &#123;<span class="doctag">@link</span> RefWatcher&#125; instance and starts watching activity references (on ICS+).</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> RefWatcher <span class="title">buildAndInstall</span><span class="params">()</span> </span>&#123;</div><div class="line">    RefWatcher refWatcher = build();</div><div class="line">    <span class="keyword">if</span> (refWatcher != DISABLED) &#123;</div><div class="line">        LeakCanary.enableDisplayLeakActivity(context);</div><div class="line">        ActivityRefWatcher.install((Application) context, refWatcher);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> refWatcher;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为分析泄漏信息是在另一个进程，如果判断出当前Application启动是在分析泄漏信息的进程中，就返回DISABLED，不去执行后续的初始化操作。如果发现是在应用主进程中，就会进行一些初始化操作。
LeakCanary.enableDisplayLeakActivity(context);这个是调用PackageManager将DisplayLeakActivity设置为可用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">enableDisplayLeakActivity</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">  LeakCanaryInternals.setEnabledBlocking(context, DisplayLeakActivity.class, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setEnabledBlocking</span><span class="params">(Context appContext, Class&lt;?&gt; componentClass,</span></span></div><div class="line">    <span class="keyword">boolean</span> enabled) &#123;</div><div class="line">  ComponentName component = <span class="keyword">new</span> ComponentName(appContext, componentClass);</div><div class="line">  PackageManager packageManager = appContext.getPackageManager();</div><div class="line">  <span class="keyword">int</span> newState = enabled ? COMPONENT_ENABLED_STATE_ENABLED : COMPONENT_ENABLED_STATE_DISABLED;</div><div class="line">  <span class="comment">// Blocks on IPC.</span></div><div class="line">  packageManager.setComponentEnabledSetting(component, newState, DONT_KILL_APP);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从配置文件中可以看见LeakCanary的这几个服务都是在新的进程中运行的，DisplayLeakActivity默认是不可用android:enabled=“false”，这样才能在一开始未存在内存泄漏时候，隐藏LeakCanary图标的。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">&lt;application&gt;</div><div class="line">    &lt;service</div><div class="line">        android:name=".internal.HeapAnalyzerService"</div><div class="line">        android:process=":leakcanary"</div><div class="line">        android:enabled="false"/&gt;</div><div class="line">    &lt;service</div><div class="line">        android:name=".DisplayLeakService"</div><div class="line">        android:process=":leakcanary"</div><div class="line">        android:enabled="false"/&gt;</div><div class="line">    &lt;activity</div><div class="line">        android:theme="@style/leak_canary_LeakCanary.Base"</div><div class="line">        android:name=".internal.DisplayLeakActivity"</div><div class="line">        android:process=":leakcanary"</div><div class="line">        android:enabled="false"</div><div class="line">        android:label="@string/leak_canary_display_activity_label"</div><div class="line">        android:icon="@drawable/leak_canary_icon"</div><div class="line">        android:taskAffinity="com.squareup.leakcanary.$&#123;applicationId&#125;"&gt;</div><div class="line">      &lt;intent-filter&gt;</div><div class="line">        &lt;action android:name="android.intent.action.MAIN"/&gt;</div><div class="line">        &lt;category android:name="android.intent.category.LAUNCHER"/&gt;</div><div class="line">      &lt;/intent-filter&gt;</div><div class="line">    &lt;/activity&gt;</div><div class="line">    &lt;activity</div><div class="line">        android:theme="@style/leak_canary_Theme.Transparent"</div><div class="line">        android:name=".internal.RequestStoragePermissionActivity"</div><div class="line">        android:process=":leakcanary"</div><div class="line">        android:taskAffinity="com.squareup.leakcanary.$&#123;applicationId&#125;"</div><div class="line">        android:enabled="false"</div><div class="line">        android:excludeFromRecents="true"</div><div class="line">        android:icon="@drawable/leak_canary_icon"</div><div class="line">        android:label="@string/leak_canary_storage_permission_activity_label"/&gt;</div><div class="line">&lt;/application&gt;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">紧接着执行了ActivityRefWatcher.install((Application) context, refWatcher);，这里将实例化的RefWatcher当做入参传入，同时对Activity的生命周期进行了监听。</div><div class="line">```java </div><div class="line">public static void install(Application application, RefWatcher refWatcher) &#123;</div><div class="line">    (new ActivityRefWatcher(application, refWatcher)).watchActivities();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void watchActivities() &#123;</div><div class="line">    // Make sure you don't get installed twice.</div><div class="line">    stopWatchingActivities();</div><div class="line">    application.registerActivityLifecycleCallbacks(lifecycleCallbacks);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public void stopWatchingActivities() &#123;</div><div class="line">    application.unregisterActivityLifecycleCallbacks(lifecycleCallbacks);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void onActivityDestroyed(Activity activity) &#123;</div><div class="line">    this.refWatcher.watch(activity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private final ActivityLifecycleCallbacks lifecycleCallbacks = new ActivityLifecycleCallbacks() &#123;</div><div class="line">    public void onActivityCreated(Activity activity, Bundle savedInstanceState) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void onActivityStarted(Activity activity) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void onActivityResumed(Activity activity) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void onActivityPaused(Activity activity) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void onActivityStopped(Activity activity) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void onActivitySaveInstanceState(Activity activity, Bundle outState) &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void onActivityDestroyed(Activity activity) &#123;</div><div class="line">        ActivityRefWatcher.this.onActivityDestroyed(activity);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>可以看到为了保证不初始化两次监听，先移除了一次，然后再次添加了监听。每次当Activity执行完onDestroy生命周期，LeakCanary就会获取到这个Activity，然后对它进行分析，查看是否存在内存泄漏。
RefWatcher类中有一些成员变量，解释一下它们的作用。
watchExecutor 确保分析任务操作是在主线程进行的，同时默认延迟5秒执行分析任务，留时间给系统GC。
debuggerControl debug控制中心。
gcTrigger 内部调用Runtime.getRuntime().gc()，手动触发系统GC。
heapDumper 用于创建.hprof文件，用于储存heap堆的快照，可以获知程序的哪些部分正在使用大部分的内存。
heapDumpListener 分析结果完成后，会告诉这个监听者。
excludedRefs 白名单，分析内存泄漏忽略的名单。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RefWatcher</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RefWatcher DISABLED = (<span class="keyword">new</span> RefWatcherBuilder()).build();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WatchExecutor watchExecutor;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DebuggerControl debuggerControl;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GcTrigger gcTrigger;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HeapDumper heapDumper;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; retainedKeys;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queue;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Listener heapdumpListener;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExcludedRefs excludedRefs;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="判断是否存在内存泄漏"><a class="header-anchor" href="#判断是否存在内存泄漏">¶</a>判断是否存在内存泄漏</h4>
<p>从上面Activity生命周期监听回调可以看见，每次当Activity执行完onDestroy生命周期，会调用RefWatcher去分析是否存在内存泄漏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* Identical to &#123;<span class="doctag">@link</span> #watch(Object, String)&#125; with an empty string reference name.</div><div class="line">*</div><div class="line">* <span class="doctag">@see</span> #watch(Object, String)</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watch</span><span class="params">(Object watchedReference)</span> </span>&#123;</div><div class="line">    watch(watchedReference, <span class="string">""</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* Watches the provided references and checks if it can be GCed. This method is non blocking,</div><div class="line">* the check is done on the &#123;<span class="doctag">@link</span> WatchExecutor&#125; this &#123;<span class="doctag">@link</span> RefWatcher&#125; has been constructed</div><div class="line">* with.</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> referenceName An logical identifier for the watched object.</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watch</span><span class="params">(Object watchedReference, String referenceName)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == DISABLED) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    checkNotNull(watchedReference, <span class="string">"watchedReference"</span>);</div><div class="line">    checkNotNull(referenceName, <span class="string">"referenceName"</span>);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> watchStartNanoTime = System.nanoTime();</div><div class="line">    String key = UUID.randomUUID().toString();</div><div class="line">    retainedKeys.add(key);</div><div class="line">    <span class="keyword">final</span> KeyedWeakReference reference =</div><div class="line">        <span class="keyword">new</span> KeyedWeakReference(watchedReference, key, referenceName, queue);</div><div class="line"></div><div class="line">    ensureGoneAsync(watchStartNanoTime, reference);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>checkNotNull()方法可以不用管，用来判断对象是否为null。在这里声明了一个弱引用，将Activity放入，然后调用了ensureGoneAsync()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureGoneAsync</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> watchStartNanoTime, <span class="keyword">final</span> KeyedWeakReference reference)</span> </span>&#123;</div><div class="line">    watchExecutor.execute(<span class="keyword">new</span> Retryable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> Retryable.<span class="function">Result <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> ensureGone(reference, watchStartNanoTime);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先生成一个随机数用作key放在retainedKeys容器里面，用来区分待分析对象是否被回收，然后使用watchExecutor去调度分析任务，主要有两点，一保证分析是在主线程进行，二延迟五秒分析内存泄漏，给系统GC时间。这部分有兴趣可以深入去看一下，与分析的主流程关系不大，我们接下继续看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">Retryable.<span class="function">Result <span class="title">ensureGone</span><span class="params">(<span class="keyword">final</span> KeyedWeakReference reference, <span class="keyword">final</span> <span class="keyword">long</span> watchStartNanoTime)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> gcStartNanoTime = System.nanoTime();</div><div class="line">    <span class="keyword">long</span> watchDurationMs = NANOSECONDS.toMillis(gcStartNanoTime - watchStartNanoTime);</div><div class="line"></div><div class="line">    removeWeaklyReachableReferences();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (debuggerControl.isDebuggerAttached()) &#123;</div><div class="line">      <span class="comment">// The debugger can create false leaks.</span></div><div class="line">      <span class="keyword">return</span> RETRY;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (gone(reference)) &#123;</div><div class="line">      <span class="keyword">return</span> DONE;</div><div class="line">    &#125;</div><div class="line">    gcTrigger.runGc();</div><div class="line">    removeWeaklyReachableReferences();</div><div class="line">    <span class="keyword">if</span> (!gone(reference)) &#123;</div><div class="line">        <span class="keyword">long</span> startDumpHeap = System.nanoTime();</div><div class="line">        <span class="keyword">long</span> gcDurationMs = NANOSECONDS.toMillis(startDumpHeap - gcStartNanoTime);</div><div class="line"></div><div class="line">        File heapDumpFile = heapDumper.dumpHeap();</div><div class="line">        <span class="keyword">if</span> (heapDumpFile == RETRY_LATER) &#123;</div><div class="line">            <span class="comment">// Could not dump the heap.</span></div><div class="line">            <span class="keyword">return</span> RETRY;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> heapDumpDurationMs = NANOSECONDS.toMillis(System.nanoTime() - startDumpHeap);</div><div class="line">        heapdumpListener.analyze(</div><div class="line">            <span class="keyword">new</span> HeapDump(heapDumpFile, reference.key, reference.name, excludedRefs, watchDurationMs,</div><div class="line">            gcDurationMs, heapDumpDurationMs));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> DONE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeWeaklyReachableReferences</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// WeakReferences are enqueued as soon as the object to which they point to becomes weakly</span></div><div class="line">    <span class="comment">// reachable. This is before finalization or garbage collection has actually happened.</span></div><div class="line">    KeyedWeakReference ref;</div><div class="line">    <span class="keyword">while</span> ((ref = (KeyedWeakReference) queue.poll()) != <span class="keyword">null</span>) &#123;</div><div class="line">        retainedKeys.remove(ref.key);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">gone</span><span class="params">(KeyedWeakReference reference)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>.retainedKeys.contains(reference.key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里首先执行removeWeaklyReachableReferences()尝试着从弱引用的队列中获取待分析对象，如果不为空，那么说明已经被系统回收了，就将retainedKeys中对应的key去掉。如果被系统回收了，直接就返回DONE；如果没有被系统回收，可能存在内存泄漏，为了保证结果的准确性，调用gcTrigger.runGc();，手动触发系统GC，然后再尝试移除待分析对象，如果还存在，说明存在内存泄漏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runGc</span><span class="params">()</span> </span>&#123;</div><div class="line">    Runtime.getRuntime().gc();</div><div class="line">    <span class="keyword">this</span>.enqueueReferences();</div><div class="line">    System.runFinalization();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueueReferences</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Thread.sleep(<span class="number">100L</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException var2) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>手动触发系统GC后，enqueueReference()方法通过沉睡100毫秒给系统GC时间，System.runFinalization()是强制调用已经失去引用的对象的finalize方法。
确定有内存泄漏后，调用heapDumper.dumpHeap()生成.hprof文件目录，然后回调heapdumpListener监听，这个监听者具体实现是ServiceHeapDumpListener类，会回调到analyze()方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">analyze</span><span class="params">(HeapDump heapDump)</span> </span>&#123;</div><div class="line">    Preconditions.checkNotNull(heapDump, <span class="string">"heapDump"</span>);</div><div class="line">    HeapAnalyzerService.runAnalysis(<span class="keyword">this</span>.context, heapDump, <span class="keyword">this</span>.listenerServiceClass);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeapDump是个model类，里面用于储存一些分析类强引用路径的需要的信息。HeapAnalyzerService.runAnalysis方法是发送了一个Intent，启动了HeapAnalyzerService服务，这个服务是IntentService。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runAnalysis</span><span class="params">(Context context, HeapDump heapDump, Class&lt;? extends AbstractAnalysisResultService&gt; listenerServiceClass)</span></span>&#123;</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(context, HeapAnalyzerService.class);</div><div class="line">    intent.putExtra(<span class="string">"listener_class_extra"</span>, listenerServiceClass.getName());</div><div class="line">    intent.putExtra(<span class="string">"heapdump_extra"</span>, heapDump);</div><div class="line">    context.startService(intent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动Service后，会在onHandleIntent分析，找到内存泄漏对象的引用关系。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(intent == <span class="keyword">null</span>) &#123;</div><div class="line">        CanaryLog.d(<span class="string">"HeapAnalyzerService received a null intent, ignoring."</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        String listenerClassName = intent.getStringExtra(<span class="string">"listener_class_extra"</span>);</div><div class="line">        HeapDump heapDump = (HeapDump)intent.getSerializableExtra(<span class="string">"heapdump_extra"</span>);</div><div class="line">        HeapAnalyzer heapAnalyzer = <span class="keyword">new</span> HeapAnalyzer(heapDump.excludedRefs);</div><div class="line">        AnalysisResult result = heapAnalyzer.checkForLeak(heapDump.heapDumpFile, heapDump.referenceKey);</div><div class="line">        AbstractAnalysisResultService.sendResultToListener(<span class="keyword">this</span>, listenerClassName, heapDump, result);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="找到引用关系"><a class="header-anchor" href="#找到引用关系">¶</a>找到引用关系</h4>
<p>启动分析泄漏的服务后，会实例化一个HeapAnalyzer对象，然后调用它的checkForLeak()方法来分析最终得到结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> AnalysisResult <span class="title">checkForLeak</span><span class="params">(File heapDumpFile, String referenceKey)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> analysisStartNanoTime = System.nanoTime();</div><div class="line">    <span class="keyword">if</span>(!heapDumpFile.exists()) &#123;</div><div class="line">        IllegalArgumentException e1 = <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File does not exist: "</span> + heapDumpFile);</div><div class="line">        <span class="keyword">return</span> AnalysisResult.failure(e1, <span class="keyword">this</span>.since(analysisStartNanoTime));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            MemoryMappedFileBuffer e = <span class="keyword">new</span> MemoryMappedFileBuffer(heapDumpFile);</div><div class="line">            HprofParser parser = <span class="keyword">new</span> HprofParser(e);</div><div class="line">            Snapshot snapshot = parser.parse();</div><div class="line">            <span class="keyword">this</span>.deduplicateGcRoots(snapshot);</div><div class="line">            Instance leakingRef = <span class="keyword">this</span>.findLeakingReference(referenceKey, snapshot);</div><div class="line">            <span class="keyword">return</span> leakingRef == <span class="keyword">null</span>?AnalysisResult.noLeak(<span class="keyword">this</span>.since(analysisStartNanoTime)):<span class="keyword">this</span>.findLeakTrace(analysisStartNanoTime, snapshot, leakingRef);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</div><div class="line">            <span class="keyword">return</span> AnalysisResult.failure(var9, <span class="keyword">this</span>.since(analysisStartNanoTime));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里用到了Square的另一个库haha，哈哈哈哈哈，名字真的就是叫这个，开源地址：<a href="https://github.com/square/haha%E3%80%82" target="_blank" rel="external">https://github.com/square/haha。</a>
首先用HprofParser类获取到内存中的heap堆快照，然后对调用deduplicateGcRoots()对快照做了去重处理，去除一些重复的强引用关系。findLeakingReference()方法就是拿到待分析的类，去快照里面找引用关系，并将结果返回。
HeapAnalyzerService服务拿到分析结果后，调用了AbstractAnalysisResultService.sendResultToListener()方法，这个方法启动了另一个服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendResultToListener</span><span class="params">(Context context, String listenerServiceClassName, HeapDump heapDump, AnalysisResult result)</span> </span>&#123;</div><div class="line">    Class listenerServiceClass;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        listenerServiceClass = Class.forName(listenerServiceClassName);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException var6) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(var6);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(context, listenerServiceClass);</div><div class="line">    intent.putExtra(<span class="string">"heap_dump_extra"</span>, heapDump);</div><div class="line">    intent.putExtra(<span class="string">"result_extra"</span>, result);</div><div class="line">    context.startService(intent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>listenerServiceClassName就是开始LeakCanary.install方法传入的DisplayLeakService类，它本身也是个IntentService服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onHandleIntent</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">    HeapDump heapDump = (HeapDump)intent.getSerializableExtra(<span class="string">"heap_dump_extra"</span>);</div><div class="line">    AnalysisResult result = (AnalysisResult)intent.getSerializableExtra(<span class="string">"result_extra"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">this</span>.onHeapAnalyzed(heapDump, result);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        heapDump.heapDumpFile.delete();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务启动后，会调用自身的onHeapAnalyzed方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onHeapAnalyzed</span><span class="params">(HeapDump heapDump, AnalysisResult result)</span> </span>&#123;</div><div class="line">    String leakInfo = LeakCanary.leakInfo(<span class="keyword">this</span>, heapDump, result, <span class="keyword">true</span>);</div><div class="line">    CanaryLog.d(<span class="string">"%s"</span>, <span class="keyword">new</span> Object[]&#123;leakInfo&#125;);</div><div class="line">    <span class="keyword">boolean</span> resultSaved = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> shouldSaveResult = result.leakFound || result.failure != <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span>(shouldSaveResult) &#123;</div><div class="line">        heapDump = <span class="keyword">this</span>.renameHeapdump(heapDump);</div><div class="line">        resultSaved = <span class="keyword">this</span>.saveResult(heapDump, result);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    PendingIntent pendingIntent;</div><div class="line">    String contentTitle;</div><div class="line">    String contentText;</div><div class="line"></div><div class="line">    <span class="comment">// 设置消息通知的 pendingIntent/contentTitle/contentText</span></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">int</span> notificationId1 = (<span class="keyword">int</span>)(SystemClock.uptimeMillis() / <span class="number">1000L</span>);</div><div class="line">    LeakCanaryInternals.showNotification(<span class="keyword">this</span>, contentTitle, contentText, pendingIntent, notificationId1);</div><div class="line">    <span class="keyword">this</span>.afterDefaultHandling(heapDump, result, leakInfo);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个方法中对判断是否需要将内存泄漏信息存到本地，如果需要就存到本地，然后设置消息通知的基本信息，通过LeakCanaryInternals.showNotification方法调用系统自身的通知栏通知，告诉用户应用有内存泄漏。
至此所有LeakCanary的检测过程通过源码的形式都梳理了一遍。</p>
<h3 id="总结"><a class="header-anchor" href="#总结">¶</a>总结</h3>
<p>LeakCanary对于内存泄漏的检测非常有效，但也并不是所有的内存泄漏都能检测出来。
无法检测出Service中的内存泄漏问题
如果最底层的MainActivity一直未走onDestroy生命周期(它在Activity栈的最底层)，无法检测出它的调用栈的内存泄漏。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/LeakCanary/" rel="tag"># LeakCanary</a>
          
            <a href="/tags/内存泄露/" rel="tag"># 内存泄露</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/12/java基础/adapter设计模式/" rel="next" title="适配器模式">
                <i class="fa fa-chevron-left"></i> 适配器模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://image-1252244366.costj.myqcloud.com/lieeber.jpg"
               alt="lieeber" />
          <p class="site-author-name" itemprop="name">lieeber</p>
           
              <p class="site-description motion-element" itemprop="description">时光足迹，心灵手记。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Lieeber" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.weibo.com/108504315" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/lieeber/activities" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.eason-li.cn/" title="eason-li" target="_blank">eason-li</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://macshuo.com/" title="迟建强" target="_blank">迟建强</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用"><span class="nav-number">1.</span> <span class="nav-text">¶使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原理"><span class="nav-number">2.</span> <span class="nav-text">¶原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#监听"><span class="nav-number">2.1.</span> <span class="nav-text">¶监听</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检测"><span class="nav-number">2.2.</span> <span class="nav-text">¶检测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分析"><span class="nav-number">2.3.</span> <span class="nav-text">¶分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析"><span class="nav-number">3.</span> <span class="nav-text">¶源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#监听-v2"><span class="nav-number">3.1.</span> <span class="nav-text">¶监听</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#判断是否存在内存泄漏"><span class="nav-number">3.2.</span> <span class="nav-text">¶判断是否存在内存泄漏</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#找到引用关系"><span class="nav-number">3.3.</span> <span class="nav-text">¶找到引用关系</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">¶总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lieeber</span>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "54270e564b8043759233e4d5e4a32650",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
